<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tonel 333 - Controle de Fiado</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #f8fafc;
  padding: 20px;
}

h2 {
  text-align: center;
}

h3 {
  margin-top: 25px;
  border-bottom: 1px solid #334155;
  padding-bottom: 5px;
}

input, select {
  width: 100%;
  padding: 12px;
  margin: 6px 0;
  border-radius: 8px;
  border: 1px solid #334155;
  background: #1e293b;
  color: #ffffff;
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border-radius: 8px;
  border: none;
  font-weight: bold;
  cursor: pointer;
}

.btn-consumo {
  background: #dc2626;
  color: white;
}

.btn-pagamento {
  background: #16a34a;
  color: white;
}

.btn-whats {
  background: #25D366;
  color: black;
}

.cliente {
  background: #1e293b;
  padding: 15px;
  margin-top: 15px;
  border-radius: 12px;
}

.saldo {
  font-weight: bold;
  color: #facc15;
}
</style>
</head>

<body>

<h2>Tonel 333 - Controle de Fiado</h2>

<h3>Cadastrar Cliente</h3>
<input type="text" id="nome" placeholder="Nome">
<input type="text" id="telefone" placeholder="Telefone 5511999999999">
<button onclick="cadastrar()">Cadastrar</button>

<h3>Movimentação</h3>
<select id="clienteSelect"></select>
<input type="number" id="valor" placeholder="Valor">
<button class="btn-consumo" onclick="adicionarConsumo()">Adicionar Consumo</button>
<button class="btn-pagamento" onclick="registrarPagamento()">Registrar Pagamento</button>

<h3>Clientes</h3>
<div id="lista"></div>

<script>

let clientes = [];

function salvar(){
  localStorage.setItem("clientes", JSON.stringify(clientes));
  mostrar();
  atualizarSelect();
}

function carregar(){
  clientes = JSON.parse(localStorage.getItem("clientes")) || [];
  mostrar();
  atualizarSelect();
}

function cadastrar(){
  let nome = document.getElementById("nome").value;
  let telefone = document.getElementById("telefone").value;

  if(nome === "" || telefone === ""){
    alert("Preencha todos os campos");
    return;
  }

  clientes.push({
    nome: nome,
    telefone: telefone,
    saldo: 0,
    historico: []
  });

  document.getElementById("nome").value="";
  document.getElementById("telefone").value="";

  salvar();
}

function atualizarSelect(){
  let select = document.getElementById("clienteSelect");
  select.innerHTML = "";

  for(let i=0; i<clientes.length; i++){
    select.innerHTML += "<option value='" + clientes[i].nome + "'>" + clientes[i].nome + "</option>";
  }
}

function adicionarConsumo(){
  let nome = document.getElementById("clienteSelect").value;
  let valor = parseFloat(document.getElementById("valor").value);

  if(!valor){
    alert("Digite um valor");
    return;
  }

  for(let i=0; i<clientes.length; i++){
    if(clientes[i].nome === nome){
      clientes[i].saldo += valor;

      clientes[i].historico.push({
        data: new Date().toLocaleDateString(),
        tipo: "Consumo",
        valor: valor
      });
    }
  }

  document.getElementById("valor").value="";
  salvar();
}

function registrarPagamento(){
  let nome = document.getElementById("clienteSelect").value;
  let valor = parseFloat(document.getElementById("valor").value);

  if(!valor){
    alert("Digite um valor");
    return;
  }

  for(let i=0; i<clientes.length; i++){
    if(clientes[i].nome === nome){
      clientes[i].saldo -= valor;

      if(clientes[i].saldo < 0){
        clientes[i].saldo = 0;
      }

      clientes[i].historico.push({
        data: new Date().toLocaleDateString(),
        tipo: "Pagamento",
        valor: valor
      });
    }
  }

  document.getElementById("valor").value="";
  salvar();
}

function enviarWhatsApp(index){
  let cliente = clientes[index];
  let telefone = cliente.telefone.replace(/\D/g, "");

  let mensagem = "Extrato - Tonel 333\n\n";

  for(let i=0; i<cliente.historico.length; i++){
    mensagem += cliente.historico[i].data + " - " +
                cliente.historico[i].tipo + " - R$ " +
                cliente.historico[i].valor.toFixed(2) + "\n";
  }

  mensagem += "\nSaldo atual: R$ " + cliente.saldo.toFixed(2);

  let url = "https://api.whatsapp.com/send?phone=" +
            telefone +
            "&text=" + encodeURIComponent(mensagem);

  window.open(url, "_blank");
}

function mostrar(){
  let lista = document.getElementById("lista");
  lista.innerHTML = "";

  for(let i=0; i<clientes.length; i++){

    let extrato = "";

    for(let j=0; j<clientes[i].historico.length; j++){
      extrato += clientes[i].historico[j].data + " - " +
                 clientes[i].historico[j].tipo + " - R$ " +
                 clientes[i].historico[j].valor.toFixed(2) + "<br>";
    }

    lista.innerHTML +=
      "<div class='cliente'>" +
      "<b>" + clientes[i].nome + "</b><br>" +
      "Telefone: " + clientes[i].telefone + "<br>" +
      "<div class='saldo'>Saldo: R$ " + clientes[i].saldo.toFixed(2) + "</div>" +
      "<br><b>Histórico:</b><br>" +
      extrato +
      "<br><button class='btn-whats' onclick='enviarWhatsApp(" + i + ")'>Enviar WhatsApp</button>" +
      "</div>";
  }
}

carregar();

</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>

</body>
  </html>
