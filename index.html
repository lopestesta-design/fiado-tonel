<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fiado Tonel 333</title>

<style>
body { font-family: Arial; background:#111; color:#fff; padding:20px; }
h1 { color:#ffcc00; }
input, select, button { margin:5px; padding:8px; }
.cliente {
  background:#222;
  padding:15px;
  margin-bottom:15px;
  border-radius:8px;
}
.saldo { font-size:18px; margin-top:5px; }
.btn-whats { background:green; color:white; border:none; cursor:pointer; }
.alerta { background:#ffe6e6; color:#000; }
.total { font-size:20px; margin-bottom:20px; color:#ffcc00; }
</style>
</head>

<body>

<h1>Fiado Tonel 333</h1>

<div class="total" id="totalGeral"></div>

<h3>Novo Cliente</h3>
<input type="text" id="nome" placeholder="Nome">
<input type="text" id="telefone" placeholder="Telefone (somente n√∫meros)">
<select id="categoria">
  <option value="fiado">Fiado (Limite 200)</option>
  <option value="mensal">Conta Mensal</option>
</select>
<button onclick="adicionarCliente()">Adicionar</button>

<hr>

<div id="lista"></div>


<script>

let clientes = [];

function salvar(){
  localStorage.setItem("clientes", JSON.stringify(clientes));
}

function carregar(){
  let dados = localStorage.getItem("clientes");
  if(dados){
    clientes = JSON.parse(dados);

    // Corrigir clientes antigos que n√£o t√™m categoria/limite
    for(let i=0; i<clientes.length; i++){
      if(!clientes[i].categoria){
        clientes[i].categoria = "fiado";
      }
      if(!clientes[i].limite){
        clientes[i].limite = clientes[i].categoria === "mensal" ? 800 : 200;
      }
      if(!clientes[i].historico){
        clientes[i].historico = [];
      }
    }
  }
  salvar();
  mostrar();
}

function adicionarCliente(){
  let nome = document.getElementById("nome").value;
  let telefone = document.getElementById("telefone").value;
  let categoria = document.getElementById("categoria").value;

  let limite = categoria === "mensal" ? 800 : 200;

  clientes.push({
    nome,
    telefone,
    categoria,
    limite,
    saldo: 0,
    historico: []
  });

  salvar();
  mostrar();
}

function registrarConsumo(i){
  let valor = parseFloat(prompt("Valor do consumo:"));
  if(isNaN(valor)) return;

  let cliente = clientes[i];

  // Fiado bloqueia
  if(cliente.categoria === "fiado"){
    if(cliente.saldo + valor > cliente.limite){
      alert("Limite de R$ 200 atingido! Precisa pagar antes de consumir mais.");
      return;
    }
  }

  // Mensal n√£o bloqueia, s√≥ acumula
  cliente.saldo += valor;

  cliente.historico.push({
    data: new Date().toLocaleDateString(),
    tipo: "Consumo",
    valor
  });

  salvar();
  mostrar();
}

function registrarPagamento(i){
  let valor = parseFloat(prompt("Valor do pagamento:"));
  if(isNaN(valor)) return;

  clientes[i].saldo -= valor;

  clientes[i].historico.push({
    data: new Date().toLocaleDateString(),
    tipo: "Pagamento",
    valor
  });

  salvar();
  mostrar();
}

function enviarWhatsApp(i){
  let cliente = clientes[i];

  let mensagem =
`üç∫ Tonel 333 Rock Sambar

Ol√° ${cliente.nome}!
Seu saldo atual √© R$ ${cliente.saldo.toFixed(2)}.

Segue PIX para pagamento:
14341419000111

Obrigado pela parceria üôè`;

  let url = "https://wa.me/55" + cliente.telefone + "?text=" + encodeURIComponent(mensagem);
  window.open(url, '_blank');
}

function mostrar(){
  let lista = document.getElementById("lista");
  let total = 0;
  lista.innerHTML = "";

  for(let i=0; i<clientes.length; i++){

    let cliente = clientes[i];
    total += cliente.saldo;

    let extrato = "";
    for(let j=0; j<cliente.historico.length; j++){
      extrato += cliente.historico[j].data + " - " +
                 cliente.historico[j].tipo + " - R$ " +
                 cliente.historico[j].valor.toFixed(2) + "<br>";
    }

    // Alerta visual se passar 90% do limite
    let classe = "cliente";
    if(cliente.saldo >= cliente.limite * 0.9){
      classe += " alerta";
    }

    lista.innerHTML +=
      "<div class='"+classe+"'>" +
      "<b>" + cliente.nome + "</b><br>" +
      "Telefone: " + cliente.telefone + "<br>" +
      "Categoria: " + cliente.categoria + "<br>" +
      "Limite: R$ " + cliente.limite.toFixed(2) + "<br>" +
      "<div class='saldo'>Saldo: R$ " + cliente.saldo.toFixed(2) + "</div>" +
      "<br><button onclick='registrarConsumo("+i+")'>Adicionar Consumo</button>" +
      "<button onclick='registrarPagamento("+i+")'>Registrar Pagamento</button>" +
      "<button class='btn-whats' onclick='enviarWhatsApp("+i+")'>Cobrar WhatsApp</button>" +
      "<br><br><b>Hist√≥rico:</b><br>" +
      extrato +
      "</div>";
  }

  document.getElementById("totalGeral").innerHTML =
    "üí∞ Total Geral em Aberto: R$ " + total.toFixed(2);
}

carregar();

</script>
</body>
</html>
