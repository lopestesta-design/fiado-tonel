<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tonel 333 - Controle de Fiado</title>

<style>
body { 
  font-family: Arial; 
  background:#111; 
  color:white; 
  padding:10px; 
  margin:0;
}
h1,h3 { text-align:center; margin-bottom:8px; }
input,select,button { width:100%; padding:16px; margin-top:8px; font-size:18px; border-radius:10px; border:none; }
input,select { background:#222; color:white; }
button { font-weight:bold; cursor:pointer; }
.btn-add { background:#28a745; color:white; }
.btn-consumo { background:#dc2626; color:white; }
.btn-pagamento { background:#16a34a; color:white; }
.btn-whats { background:#25D366; color:white; }
.btn-backup { background:#ff9800; color:white; }
.btn-zerar { background:#f44336; color:white; }
.cliente { 
  background:#1e1e1e; 
  padding:12px; 
  margin-top:10px; 
  border-radius:10px; 
  font-size:16px; 
  position:relative;
  word-wrap: break-word;
}
#totalSaldo { text-align:center; font-size:18px; margin-bottom:10px; font-weight:bold; color:#ffcc00; }
button.excluir, button.editar {
  position:absolute; top:5px; width:32px; height:32px; border:none; border-radius:50%; font-weight:bold; cursor:pointer;
}
button.excluir { right:5px; background:red; color:white; }
button.editar { right:45px; background:#f59e0b; color:white; }
</style>
</head>

<body>

<h1>Tonel 333 - Controle de Fiado</h1>
<div id="totalSaldo">Total Geral: R$ 0,00</div>

<h3>Cadastrar Cliente</h3>
<input type="text" id="nome" placeholder="Nome do Cliente">
<input type="tel" id="telefone" placeholder="Telefone 5511999999999">
<button type="button" class="btn-add" onclick="cadastrarCliente()">Cadastrar</button>

<h3>Movimentação</h3>
<select id="clienteSelect"></select>
<input type="number" id="valor" placeholder="Valor">
<button type="button" class="btn-consumo" onclick="adicionarConsumo()">Adicionar Consumo</button>
<button type="button" class="btn-pagamento" onclick="registrarPagamento()">Registrar Pagamento</button>

<h3>Buscar Cliente</h3>
<input type="text" id="buscaCliente" placeholder="Digite o nome do cliente..." onkeyup="filtrarClientes()">

<h3>Backup</h3>
<button class="btn-backup" onclick="exportarBackupLocal()">Salvar Backup</button>
<button class="btn-backup" onclick="restaurarBackup()">Restaurar Backup</button>
<button class="btn-zerar" onclick="zerarClientes()">Zerar todos</button>

<div id="lista"></div>

<script>
let clientes = JSON.parse(localStorage.getItem("clientes")) || [];
const LIMITE_SALDO = 200;

function salvar(){
  localStorage.setItem("clientes", JSON.stringify(clientes));
  localStorage.setItem("backup_clientes", JSON.stringify(clientes));
  atualizarLista(); atualizarSelect(); atualizarTotal();
}

function carregar(){ clientes = JSON.parse(localStorage.getItem("clientes")) || []; atualizarLista(); atualizarSelect(); atualizarTotal(); }

function cadastrarCliente(){
  let nome = document.getElementById("nome").value.trim();
  let telefone = document.getElementById("telefone").value.trim();
  if(!nome||!telefone){alert("Preencha todos os campos");return;}
  clientes.push({nome,telefone,saldo:0,historico:[]});
  document.getElementById("nome").value=""; document.getElementById("telefone").value="";
  salvar();
}

function atualizarSelect(){
  let select=document.getElementById("clienteSelect"); select.innerHTML="";
  clientes.forEach(c=>{let option=document.createElement("option"); option.value=c.nome; option.textContent=c.nome; select.appendChild(option);});
}

function adicionarConsumo(){
  let nome=document.getElementById("clienteSelect").value;
  let valor=parseFloat(document.getElementById("valor").value);
  if(!valor){alert("Digite um valor");return;}
  let cliente=clientes.find(c=>c.nome===nome);
  if(cliente){cliente.saldo+=valor; cliente.historico.push({data:new Date().toLocaleDateString(),tipo:"Consumo",valor});}
  document.getElementById("valor").value=""; salvar();
}

function registrarPagamento(){
  let nome=document.getElementById("clienteSelect").value;
  let valor=parseFloat(document.getElementById("valor").value);
  if(!valor){alert("Digite um valor");return;}
  let cliente=clientes.find(c=>c.nome===nome);
  if(cliente){cliente.saldo-=valor;if(cliente.saldo<0)cliente.saldo=0;cliente.historico.push({data:new Date().toLocaleDateString(),tipo:"Pagamento",valor});}
  document.getElementById("valor").value=""; salvar();
}

function filtrarClientes(){
  let filtro=document.getElementById("buscaCliente").value.toLowerCase();
  document.querySelectorAll("#lista .cliente").forEach(div=>{
    let nome=div.querySelector("b").textContent.toLowerCase();
    div.style.display=nome.includes(filtro)?"block":"none";
  });
}

function enviarWhatsApp(index){
  let cliente=clientes[index];
  let telefone=cliente.telefone.replace(/\D/g,"");
  let mensagem="Extrato - Tonel 333\n\n";
  cliente.historico.forEach(h=>mensagem+=h.data+" - "+h.tipo+" - R$ "+h.valor.toFixed(2)+"\n");
  mensagem+="\nSaldo atual: R$ "+cliente.saldo.toFixed(2);
  mensagem+="\n\nChave PIX: 14341419000111";
  let url="https://wa.me/"+telefone+"?text="+encodeURIComponent(mensagem);
  window.open(url,"_blank");
}

function excluirCliente(index){if(confirm("Deseja realmente excluir este cliente?")){clientes.splice(index,1); salvar();}}
function editarCliente(index){let n=prompt("Editar nome:",clientes[index].nome); if(n===null)return; let t=prompt("Editar telefone:",clientes[index].telefone); if(t===null)return; clientes[index].nome=n.trim(); clientes[index].telefone=t.trim(); salvar();}

function atualizarLista(){
  let lista=document.getElementById("lista"); lista.innerHTML="";
  clientes.forEach((c,i)=>{
    let hHTML=c.historico.map(h=>h.data+" - "+h.tipo+" - R$ "+h.valor.toFixed(2)).join("<br>");
    lista.innerHTML+=`<div class="cliente" style="color:${c.saldo>LIMITE_SALDO?'#ff4444':'white'};">
      <button class="excluir" onclick="excluirCliente(${i})">X</button>
      <button class="editar" onclick="editarCliente(${i})">✏</button>
      <b>${c.nome}</b><br>Telefone: ${c.telefone}<br><b>Saldo: R$ ${c.saldo.toFixed(2)}</b><br><br><b>Histórico:</b><br>${hHTML || "Sem movimentações"}<br><br>
      <button class="btn-whats" onclick="enviarWhatsApp(${i})">Enviar WhatsApp</button></div>`;
  });
}

function atualizarTotal(){let total=clientes.reduce((s,c)=>s+c.saldo,0);document.getElementById("totalSaldo").textContent="Total Geral: R$ "+total.toFixed(2);}
function restaurarBackup(){let b=localStorage.getItem("backup_clientes"); if(!b){alert("Nenhum backup encontrado!");return;} clientes=JSON.parse(b); salvar(); alert("Backup restaurado com sucesso!");}
function exportarBackupLocal(){const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(clientes)); const dl=document.createElement('a'); dl.setAttribute("href",dataStr); dl.setAttribute("download","backup_clientes.json"); dl.click();}
function zerarClientes(){if(confirm("Deseja realmente apagar todos os clientes e saldos?")){clientes=[]; salvar();}}

carregar();
</script>
</body>
</html>
