<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tonel 333 - Controle Completo</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f0f0f0;
  color: #222;
  padding: 15px;
  margin: 0;
}

h1,h3 {
  text-align: center;
  margin-bottom: 10px;
  color: #333;
}

h1 {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:15px;
  background:#ffe680;
  padding:10px 0;
  border-radius:12px;
  box-shadow:0 3px 6px rgba(0,0,0,0.15);
}

h1 img {
  height:70px;
  border-radius:12px;
  box-shadow:0 2px 4px rgba(0,0,0,0.2);
}

input, select, button {
  width:100%;
  padding:14px;
  margin-top:10px;
  font-size:16px;
  border-radius:8px;
  border:1px solid #ccc;
}

input, select {
  background:#fff;
  color:#222;
}

button {
  font-weight:bold;
  cursor:pointer;
  transition:0.2s;
}

button:hover {
  opacity:0.85;
}

.btn-add { background:#28a745; color:#fff; }
.btn-consumo { background:#dc2626; color:#fff; }
.btn-pagamento { background:#16a34a; color:#fff; }
.btn-whats { background:#25D366; color:#fff; }
.btn-entrada { background:#28a745; color:#fff; }
.btn-saida { background:#dc2626; color:#fff; }
.btn-backup { background:#ff9800; color:#fff; }

.cliente, .entry, .exit {
  background:#fff;
  color:#222;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  word-wrap:break-word;
}

#totalSaldo {
  text-align:center;
  font-size:20px;
  margin-bottom:12px;
  font-weight:bold;
  color:#ff6600;
}
</style>
</head>
<body>

<h1>
  <img src="logo.png" alt="Tonel 333">
  Tonel 333 - Controle Completo
</h1>

<div id="totalSaldo">Saldo Atual: R$ 0,00</div>

<!-- Cadastrar Cliente -->
<h3>Cadastrar Cliente</h3>
<input type="text" id="nome" placeholder="Nome do Cliente">
<input type="tel" id="telefone" placeholder="Telefone 5511999999999">
<button type="button" class="btn-add" onclick="cadastrarCliente()">Cadastrar</button>

<!-- Movimentação de Fiado -->
<h3>Movimentação - Fiado</h3>
<select id="clienteSelect"></select>
<input type="number" id="valor" placeholder="Valor">
<button type="button" class="btn-consumo" onclick="adicionarConsumo()">Adicionar Consumo</button>
<button type="button" class="btn-pagamento" onclick="registrarPagamento()">Registrar Pagamento</button>

<!-- Entradas -->
<h3>Registrar Entrada</h3>
<input type="text" id="descricaoEntrada" placeholder="Descrição">
<input type="number" id="valorEntrada" placeholder="Valor R$">
<select id="formaPagamento">
  <option value="dinheiro">Dinheiro</option>
  <option value="pix">PIX</option>
  <option value="debito">Débito</option>
  <option value="credito">Crédito</option>
</select>
<input type="number" id="taxaCartao" placeholder="Taxa % (somente débito/crédito)">
<button class="btn-entrada" onclick="registrarEntrada()">Adicionar Entrada</button>

<!-- Saídas -->
<h3>Registrar Saída</h3>
<input type="text" id="descricaoSaida" placeholder="Descrição">
<input type="number" id="valorSaida" placeholder="Valor R$">
<button class="btn-saida" onclick="registrarSaida()">Adicionar Saída</button>

<!-- Histórico -->
<h3>Histórico</h3>
<div id="listaHistorico"></div>

<!-- Clientes -->
<h3>Clientes</h3>
<div id="lista"></div>

<!-- Backup -->
<button class="btn-backup" onclick="exportarBackup()">Salvar Backup</button>
<button class="btn-backup" onclick="restaurarBackup()">Restaurar Backup</button>

<script>
// === FIADO ===
let clientes = JSON.parse(localStorage.getItem("clientes")) || [];

function salvarFiado() {
  localStorage.setItem("clientes", JSON.stringify(clientes));
  atualizarListaClientes();
  atualizarSelectClientes();
}

function carregarFiado() {
  clientes = JSON.parse(localStorage.getItem("clientes")) || [];
  atualizarListaClientes();
  atualizarSelectClientes();
}

function cadastrarCliente() {
  let nome = document.getElementById("nome").value.trim();
  let telefone = document.getElementById("telefone").value.trim();
  if(!nome || !telefone){ alert("Preencha todos os campos"); return; }
  clientes.push({ nome, telefone, saldo:0, historico:[] });
  document.getElementById("nome").value = "";
  document.getElementById("telefone").value = "";
  salvarFiado();
}

function atualizarSelectClientes() {
  let select = document.getElementById("clienteSelect");
  select.innerHTML = "";
  clientes.forEach(c => {
    let option = document.createElement("option");
    option.value = c.nome;
    option.textContent = c.nome;
    select.appendChild(option);
  });
}

function adicionarConsumo() {
  let nome = document.getElementById("clienteSelect").value;
  let valor = parseFloat(document.getElementById("valor").value);
  if(!valor){ alert("Digite um valor"); return; }
  let cliente = clientes.find(c => c.nome === nome);
  if(cliente){
    cliente.saldo += valor;
    cliente.historico.push({ data:new Date().toLocaleDateString(), tipo:"Consumo", valor });
  }
  document.getElementById("valor").value = "";
  salvarFiado();
}

function registrarPagamento() {
  let nome = document.getElementById("clienteSelect").value;
  let valor = parseFloat(document.getElementById("valor").value);
  if(!valor){ alert("Digite um valor"); return; }
  let cliente = clientes.find(c => c.nome === nome);
  if(cliente){
    cliente.saldo -= valor;
    if(cliente.saldo<0) cliente.saldo=0;
    cliente.historico.push({ data:new Date().toLocaleDateString(), tipo:"Pagamento", valor });
  }
  document.getElementById("valor").value = "";
  salvarFiado();
}

function enviarWhatsApp(index) {
  let cliente = clientes[index];
  let telefone = cliente.telefone.replace(/\D/g,"");
  let mensagem = "Extrato - Tonel 333\n\n";
  cliente.historico.forEach(h=>mensagem+=`${h.data} - ${h.tipo} - R$ ${h.valor.toFixed(2)}\n`);
  mensagem += `\nSaldo atual: R$ ${cliente.saldo.toFixed(2)}\n\nChave PIX: 14341419000111`;
  let url = "https://wa.me/"+telefone+"?text="+encodeURIComponent(mensagem);
  window.open(url,"_blank");
}

function atualizarListaClientes(){
  let lista = document.getElementById("lista");
  lista.innerHTML="";
  clientes.forEach((c,i)=>{
    let historicoHTML = c.historico.map(h=>`${h.data} - ${h.tipo} - R$ ${h.valor.toFixed(2)}`).join("<br>");
    lista.innerHTML += `
      <div class="cliente">
        <b>${c.nome}</b><br>
        Telefone: ${c.telefone}<br>
        <b>Saldo: R$ ${c.saldo.toFixed(2)}</b><br><br>
        <b>Histórico:</b><br>${historicoHTML || "Sem movimentações"}<br><br>
        <button class="btn-whats" onclick="enviarWhatsApp(${i})">WhatsApp</button>
        <button style="background:#ffc107;color:#000;margin-left:5px;" onclick="editarCliente(${i})">Editar</button>
        <button style="background:#dc3545;color:#fff;margin-left:5px;" onclick="excluirCliente(${i})">Excluir</button>
      </div>`;
  });
}

function editarCliente(i){
  let novoNome = prompt("Editar nome:", clientes[i].nome);
  if(novoNome===null) return;
  let novoTel = prompt("Editar telefone:", clientes[i].telefone);
  if(novoTel===null) return;
  clientes[i].nome = novoNome.trim() || clientes[i].nome;
  clientes[i].telefone = novoTel.trim() || clientes[i].telefone;
  salvarFiado();
}

function excluirCliente(i){
  let confirmacao = confirm(`Tem certeza que deseja excluir o cliente "${clientes[i].nome}"?`);
  if(confirmacao){
    clientes.splice(i,1);
    salvarFiado();
  }
}
carregarFiado();

// === VENDAS e DESPESAS ===
let entradas = JSON.parse(localStorage.getItem("entradas")) || [];
let saidas = JSON.parse(localStorage.getItem("saidas")) || [];

function salvarVendas(){
  localStorage.setItem("entradas", JSON.stringify(entradas));
  localStorage.setItem("saidas", JSON.stringify(saidas));
  atualizarHistorico();
}

function registrarEntrada(){
  let desc=document.getElementById("descricaoEntrada").value.trim();
  let val=parseFloat(document.getElementById("valorEntrada").value);
  let forma=document.getElementById("formaPagamento").value;
  let taxa=parseFloat(document.getElementById("taxaCartao").value)||0;
  if(!desc || !val){ alert("Preencha todos os campos"); return; }
  let valLiquido=val; if(forma==="debito"||forma==="credito"){ valLiquido = val*(1-taxa/100);}
  entradas.push({descricao:desc,valor:val,forma,taxa,liquido:valLiquido,data:new Date().toLocaleDateString()});
  document.getElementById("descricaoEntrada").value="";
  document.getElementById("valorEntrada").value="";
  document.getElementById("taxaCartao").value="";
  salvarVendas();
}

function registrarSaida(){
  let desc=document.getElementById("descricaoSaida").value.trim();
  let val=parseFloat(document.getElementById("valorSaida").value);
  if(!desc||!val){ alert("Preencha todos os campos"); return; }
  saidas.push({descricao:desc,valor:val,data:new Date().toLocaleDateString()});
  document.getElementById("descricaoSaida").value="";
  document.getElementById("valorSaida").value="";
  salvarVendas();
}

function atualizarHistorico(){
  let lista=document.getElementById("listaHistorico");
  lista.innerHTML="";
  let total=0;
  entradas.forEach(e=>{lista.innerHTML+=`<div class="entry"><b>Entrada:</b> ${e.descricao} - R$ ${e.valor.toFixed(2)} (${e.forma}${e.taxa?` - Taxa ${e.taxa}%`:""}) - Líquido: R$ ${e.liquido.toFixed(2)} - ${e.data}</div>`; total+=e.liquido;});
  saidas.forEach(s=>{lista.innerHTML+=`<div class="exit"><b>Saída:</b> ${s.descricao} - R$ ${s.valor.toFixed(2)} - ${s.data}</div>`; total-=s.valor;});
  document.getElementById("totalSaldo").textContent="Saldo Atual: R$ "+total.toFixed(2);
}

// === BACKUP ===
function exportarBackup(){
  const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({clientes,entradas,saidas}));
  const dl=document.createElement('a'); dl.setAttribute("href",dataStr); dl.setAttribute("download","backup_bar.json"); dl.click();
}

function restaurarBackup(){
  let b=prompt("Cole o conteúdo JSON do backup aqui:");
  if(!b) return;
  try{
    let data=JSON.parse(b);
    clientes=data.clientes||[];
    entradas=data.entradas||[];
    saidas=data.saidas||[];
    salvarFiado();
    salvarVendas();
    alert("Backup restaurado com sucesso!");
  }catch(e){alert("Backup inválido!");}
}

atualizarHistorico();
</script>
</body>
</html>
