<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Entradas - Tonel 333</title>

<style>
body{font-family:Arial;padding:20px;background:#fff8dc;color:#5c3a00;}
.topo{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.logo{width:100px;}
.voltar{text-decoration:none;font-size:22px;color:#5c3a00;}
input,select,button{padding:6px;margin:5px 0;width:100%;}
.card{border:1px solid #5c3a00;padding:10px;margin:10px 0;border-radius:6px;background:#fff;}
button{cursor:pointer;}
</style>
</head>

<body>

<div class="topo">
<a href="index.html" class="voltar">‚Üê</a>
<img src="logo.png" class="logo">
</div>

<h2>Registrar Entrada</h2>

<input type="date" id="data">
<input type="text" id="descricao" placeholder="Descri√ß√£o">
<input type="number" id="valor" placeholder="Valor">

<select id="pagamento" onchange="verCliente()">
<option value="dinheiro">Dinheiro</option>
<option value="pix">Pix</option>
<option value="debito">D√©bito</option>
<option value="credito">Cr√©dito</option>
<option value="fiado">Fiado</option>
</select>

<select id="cliente" style="display:none;"></select>

<button onclick="salvar()">Salvar</button>

<h3>Hist√≥rico</h3>
<div id="listaEntradas"></div>

<script>
document.getElementById('data').valueAsDate = new Date();

// Fun√ß√£o confi√°vel para carregar clientes no select
function carregarClientes(){
    let clientes = JSON.parse(localStorage.getItem('clientes') || "[]");
    let select = document.getElementById('cliente');
    
    // Limpa o select
    while(select.firstChild){
        select.removeChild(select.firstChild);
    }

    if(clientes.length === 0){
        let option = document.createElement("option");
        option.textContent = "Nenhum cliente cadastrado";
        option.disabled = true;
        select.appendChild(option);
        return;
    }

    clientes.forEach(c => {
        if(c && c.nome){
            let option = document.createElement("option");
            option.value = c.nome;
            option.textContent = c.nome;
            select.appendChild(option);
        }
    });
}

// Mostrar select de clientes apenas para Fiado
function verCliente(){
    let pag = document.getElementById('pagamento').value;
    let select = document.getElementById('cliente');

    if(pag === "fiado"){
        carregarClientes();
        select.style.display = "block";
    } else {
        select.style.display = "none";
    }
}

// Salvar entrada
function salvar(){
    let entradas = JSON.parse(localStorage.getItem('entradas') || "[]");
    let fiados = JSON.parse(localStorage.getItem('fiados') || "[]");

    let data = document.getElementById('data').value;
    let descricao = document.getElementById('descricao').value;
    let valor = parseFloat(document.getElementById('valor').value);
    let pagamento = document.getElementById('pagamento').value;
    let cliente = document.getElementById('cliente').value;

    if(!descricao || isNaN(valor)) return;

    if(pagamento === "fiado" && (!cliente || cliente === "Nenhum cliente cadastrado")){
        alert("Cadastre um cliente primeiro.");
        return;
    }

    // Adiciona entrada
    entradas.push({data,descricao,valor,pagamento,cliente});
    localStorage.setItem('entradas',JSON.stringify(entradas));

    // Atualiza Fiado
    if(pagamento === "fiado"){
        let clienteFiado = fiados.find(f => f.cliente === cliente);

        if(!clienteFiado){
            clienteFiado = {cliente,consumos:[],pagamentos:[]};
            fiados.push(clienteFiado);
        }

        clienteFiado.consumos.push({data,valor});
        localStorage.setItem('fiados',JSON.stringify(fiados));
    }

    listarEntradas();
    document.getElementById('descricao').value="";
    document.getElementById('valor').value="";
}

// Listar entradas
function listarEntradas(){
    let entradas = JSON.parse(localStorage.getItem('entradas') || "[]");
    let div = document.getElementById('listaEntradas');
    div.innerHTML="";

    entradas.forEach((e,i)=>{
        div.innerHTML+=`
        <div class="card">
            ${e.data} - ${e.descricao}<br>
            R$ ${e.valor.toFixed(2)} - ${e.pagamento} ${e.pagamento==="fiado"?"- "+e.cliente:""}<br>
            <button onclick="editar(${i})">‚úè</button>
            <button onclick="excluir(${i})">üóë</button>
        </div>`;
    });
}

// Editar entrada
function editar(i){
    let entradas = JSON.parse(localStorage.getItem('entradas') || "[]");
    let fiados = JSON.parse(localStorage.getItem('fiados') || "[]");
    let e = entradas[i];

    let novoValor = parseFloat(prompt("Novo valor:", e.valor));
    if(isNaN(novoValor)) return;

    if(e.pagamento === "fiado"){
        let f = fiados.find(x => x.cliente === e.cliente);
        if(f){
            let c = f.consumos.find(x => x.data===e.data && x.valor===e.valor);
            if(c) c.valor = novoValor;
            localStorage.setItem('fiados',JSON.stringify(fiados));
        }
    }

    e.valor = novoValor;
    localStorage.setItem('entradas',JSON.stringify(entradas));
    listarEntradas();
}

// Excluir entrada
function excluir(i){
    if(!confirm("Excluir lan√ßamento?")) return;

    let entradas = JSON.parse(localStorage.getItem('entradas') || "[]");
    let fiados = JSON.parse(localStorage.getItem('fiados') || "[]");
    let e = entradas[i];

    if(e.pagamento==="fiado"){
        let f = fiados.find(x=>x.cliente===e.cliente);
        if(f){
            f.consumos = f.consumos.filter(x => !(x.data===e.data && x.valor===e.valor));
            localStorage.setItem('fiados',JSON.stringify(fiados));
        }
    }

    entradas.splice(i,1);
    localStorage.setItem('entradas',JSON.stringify(entradas));
    listarEntradas();
}

listarEntradas();
</script>
</body>
</html>
