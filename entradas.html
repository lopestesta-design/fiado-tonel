<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Entradas - Tonel 333</title>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #fff8dc;
    color: #5c3a00;
}

.topo {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.logo { width: 100px; }

.voltar {
    text-decoration: none;
    font-size: 22px;
    color: #5c3a00;
}

input, button, select {
    padding: 6px;
    margin: 5px 0;
    font-size: 16px;
    width: 100%;
}

.card {
    border: 1px solid #5c3a00;
    padding: 10px;
    margin: 10px 0;
    border-radius: 6px;
    background: #fff;
}

/* Dropdown customizado */
.dropdown {
    position: relative;
    margin: 5px 0;
}

.dropdown-toggle {
    padding: 6px;
    border: 1px solid #5c3a00;
    background: #fff8dc;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
}

.dropdown-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 50vh; /* metade da tela para rolar todos os clientes */
    border: 1px solid #5c3a00;
    background: #fff;
    overflow-y: auto;
    display: none;
    z-index: 1000;
}

.dropdown-list div {
    padding: 6px;
    cursor: pointer;
}

.dropdown-list div:hover {
    background: #ffe680;
}
</style>
</head>

<body>

<div class="topo">
<a href="index.html" class="voltar">‚Üê</a>
<img src="logo.png" class="logo">
</div>

<h2>Registrar Entrada</h2>

<input type="date" id="data">
<input type="text" id="descricao" placeholder="Descri√ß√£o">
<input type="number" id="valor" placeholder="Valor">

<select id="pagamento" onchange="verCliente()">
<option value="dinheiro">Dinheiro</option>
<option value="pix">Pix</option>
<option value="debito">D√©bito</option>
<option value="credito">Cr√©dito</option>
<option value="fiado">Fiado</option>
</select>

<!-- Dropdown customizado para clientes -->
<div class="dropdown" id="dropdownCliente" style="display:none;">
    <div class="dropdown-toggle" id="clienteSelecionado">Selecione o cliente</div>
    <div class="dropdown-list" id="listaClientes"></div>
</div>

<button onclick="salvar()">Salvar</button>

<h3>Hist√≥rico</h3>
<div id="listaEntradas"></div>

<script>
document.getElementById('data').valueAsDate = new Date();

let clienteAtual = "";

// Carrega clientes na dropdown
function carregarClientes(){
    let clientes = JSON.parse(localStorage.getItem('clientes') || "[]");
    let lista = document.getElementById('listaClientes');
    lista.innerHTML = "";

    if(clientes.length === 0){
        let div = document.createElement("div");
        div.textContent = "Nenhum cliente cadastrado";
        div.style.pointerEvents = "none";
        lista.appendChild(div);
        clienteAtual = "";
        document.getElementById('clienteSelecionado').textContent = "Nenhum cliente";
        return;
    }

    clientes.forEach(c => {
        if(c && c.nome){
            let div = document.createElement("div");
            div.textContent = c.nome;
            div.onclick = function(){
                clienteAtual = c.nome;
                document.getElementById('clienteSelecionado').textContent = c.nome;
                document.getElementById('listaClientes').style.display = "none";
            };
            lista.appendChild(div);
        }
    });
}

// Mostra dropdown somente para Fiado
function verCliente(){
    let pag = document.getElementById('pagamento').value;
    let dropdown = document.getElementById('dropdownCliente');

    if(pag === "fiado"){
        dropdown.style.display = "block";
        carregarClientes();
    } else {
        dropdown.style.display = "none";
        clienteAtual = "";
    }
}

// Toggle dropdown
document.getElementById('clienteSelecionado').onclick = function(){
    let lista = document.getElementById('listaClientes');
    lista.style.display = (lista.style.display === "block") ? "none" : "block";
}

// Salvar entrada
function salvar(){
    let entradas = JSON.parse(localStorage.getItem('entradas') || "[]");
    let fiados = JSON.parse(localStorage.getItem('fiados') || "[]");

    let data = document.getElementById('data').value;
    let descricao = document.getElementById('descricao').value;
    let valor = parseFloat(document.getElementById('valor').value);
    let pagamento = document.getElementById('pagamento').value;

    if(!descricao || isNaN(valor)) return;

    if(pagamento === "fiado" && !clienteAtual){
        alert("Cadastre um cliente primeiro.");
        return;
    }

    entradas.push({data,descricao,valor,pagamento,cliente: clienteAtual});
    localStorage.setItem('entradas',JSON.stringify(entradas));

    if(pagamento === "fiado"){
        let clienteFiado = fiados.find(f => f.cliente === clienteAtual);

        if(!clienteFiado){
            clienteFiado = {cliente: clienteAtual, consumos: [], pagamentos: []};
            fiados.push(clienteFiado);
        }

        clienteFiado.consumos.push({data,valor});
        localStorage.setItem('fiados',JSON.stringify(fiados));
    }

    listarEntradas();

    // Limpa campos
    document.getElementById('descricao').value="";
    document.getElementById('valor').value="";
    clienteAtual = "";
    document.getElementById('clienteSelecionado').textContent = "Selecione o cliente";
}

// Listar entradas
function listarEntradas(){
    let entradas = JSON.parse(localStorage.getItem('entradas') || "[]");
    let div = document.getElementById('listaEntradas');
    div.innerHTML="";

    entradas.forEach((e,i)=>{
        div.innerHTML+=`
        <div class="card">
            ${e.data} - ${e.descricao}<br>
            R$ ${e.valor.toFixed(2)} - ${e.pagamento} ${e.pagamento==="fiado"?"- "+e.cliente:""}<br>
            <button onclick="editar(${i})">‚úè</button>
            <button onclick="excluir(${i})">üóë</button>
        </div>`;
    });
}

// Editar entrada
function editar(i){
    let entradas = JSON.parse(localStorage.getItem('entradas') || "[]");
    let fiados = JSON.parse(localStorage.getItem('fiados') || "[]");
    let e = entradas[i];

    let novoValor = parseFloat(prompt("Novo valor:", e.valor));
    if(isNaN(novoValor)) return;

    if(e.pagamento === "fiado"){
        let f = fiados.find(x => x.cliente === e.cliente);
        if(f){
            let c = f.consumos.find(x => x.data===e.data && x.valor===e.valor);
            if(c) c.valor = novoValor;
            localStorage.setItem('fiados',JSON.stringify(fiados));
        }
    }

    e.valor = novoValor;
    localStorage.setItem('entradas',JSON.stringify(entradas));
    listarEntradas();
}

// Excluir entrada
function excluir(i){
    if(!confirm("Excluir lan√ßamento?")) return;

    let entradas = JSON.parse(localStorage.getItem('entradas') || "[]");
    let fiados = JSON.parse(localStorage.getItem('fiados') || "[]");
    let e = entradas[i];

    if(e.pagamento==="fiado"){
        let f = fiados.find(x=>x.cliente===e.cliente);
        if(f){
            f.consumos = f.consumos.filter(x => !(x.data===e.data && x.valor===e.valor));
            localStorage.setItem('fiados',JSON.stringify(fiados));
        }
    }

    entradas.splice(i,1);
    localStorage.setItem('entradas',JSON.stringify(entradas));
    listarEntradas();
}

listarEntradas();
</script>

</body>
</html>
