<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Entradas - Tonel 333</title>
<style>
body{font-family:Arial;padding:20px;background:#fff8dc;color:#5c3a00;}
.topo{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.logo{width:100px;}
.voltar{text-decoration:none;font-size:22px;color:#5c3a00;}
input,select,button{padding:6px;margin:5px 0;width:100%;}
.card{border:1px solid #5c3a00;padding:10px;margin:10px 0;border-radius:6px;background:#fff;}
</style>
</head>
<body>

<div class="topo">
<a href="index.html" class="voltar">‚Üê</a>
<img src="logo.png" class="logo">
</div>

<h2>Registrar Entrada</h2>

<input type="date" id="data">
<input type="text" id="descricao" placeholder="Descri√ß√£o">
<input type="number" id="valor" placeholder="Valor">

<select id="pagamento" onchange="verCliente()">
<option value="dinheiro">Dinheiro</option>
<option value="pix">Pix</option>
<option value="debito">D√©bito</option>
<option value="credito">Cr√©dito</option>
<option value="fiado">Fiado</option>
</select>

<select id="cliente" style="display:none;"></select>

<button onclick="salvar()">Salvar</button>

<h3>Hist√≥rico</h3>
<div id="listaEntradas"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC1Jqc7Jjp-NcVUaxglEhmDNklndUqaF0Y",
  authDomain: "tonel-333.firebaseapp.com",
  projectId: "tonel-333",
  storageBucket: "tonel-333.firebasestorage.app",
  messagingSenderId: "1078081349485",
  appId: "1:1078081349485:web:10bcd104cc08b2bafcdc64"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

document.getElementById('data').valueAsDate=new Date();

function carregarClientes(){
    let clientes=JSON.parse(localStorage.getItem('clientes'))||[];
    let select=document.getElementById('cliente');
    select.innerHTML="";
    if(clientes.length===0){
        select.innerHTML="<option>Nenhum cliente cadastrado</option>";
        return;
    }
    clientes.forEach(c=>select.innerHTML+=`<option value="${c.nome}">${c.nome}</option>`);
}

function verCliente(){
    let pag=document.getElementById('pagamento').value;
    let select=document.getElementById('cliente');
    select.style.display=(pag==="fiado")?"block":"none";
}

function salvar(){
    let entradas=JSON.parse(localStorage.getItem('entradas'))||[];
    let fiados=JSON.parse(localStorage.getItem('fiados'))||[];

    let data=document.getElementById('data').value;
    let descricao=document.getElementById('descricao').value.trim();
    let valor=parseFloat(document.getElementById('valor').value);
    let pagamento=document.getElementById('pagamento').value;
    let cliente=document.getElementById('cliente').value;

    if(!descricao||isNaN(valor)) return alert("Preencha descri√ß√£o e valor");

    if(pagamento==="fiado"&&(!cliente||cliente==="Nenhum cliente cadastrado")){
        return alert("Cadastre um cliente primeiro.");
    }

    let entrada={data,descricao,valor,pagamento,cliente};
    entradas.push(entrada);
    localStorage.setItem('entradas',JSON.stringify(entradas));

    // Fiado
    if(pagamento==="fiado"){
        let cFiado=fiados.find(f=>f.cliente===cliente);
        if(!cFiado){ cFiado={cliente,consumos:[],pagamentos:[]}; fiados.push(cFiado);}
        cFiado.consumos.push({data,valor});
        localStorage.setItem('fiados',JSON.stringify(fiados));
    }

    listarEntradas();
    salvarNaNuvem();
}

function listarEntradas(){
    let entradas=JSON.parse(localStorage.getItem('entradas'))||[];
    let div=document.getElementById('listaEntradas');
    div.innerHTML="";
    entradas.forEach((e,i)=>{
        div.innerHTML+=`<div class="card">
        ${e.data} - ${e.descricao}<br>
        R$ ${e.valor.toFixed(2)} - ${e.pagamento}
        ${e.pagamento==="fiado"?" - "+e.cliente:""}<br>
        <button onclick="editar(${i})">‚úè</button>
        <button onclick="excluir(${i})">üóë</button>
        </div>`;
    });
}

function editar(i){
    let entradas=JSON.parse(localStorage.getItem('entradas'))||[];
    let fiados=JSON.parse(localStorage.getItem('fiados'))||[];
    let e=entradas[i];

    let novoValor=parseFloat(prompt("Novo valor:",e.valor));
    if(isNaN(novoValor)) return;

    if(e.pagamento==="fiado"){
        let f=fiados.find(x=>x.cliente===e.cliente);
        if(f){
            let c=f.consumos.find(x=>x.data===e.data && x.valor===e.valor);
            if(c) c.valor=novoValor;
            localStorage.setItem('fiados',JSON.stringify(fiados));
        }
    }

    e.valor=novoValor;
    localStorage.setItem('entradas',JSON.stringify(entradas));
    listarEntradas();
    salvarNaNuvem();
}

function excluir(i){
    if(!confirm("Excluir lan√ßamento?")) return;
    let entradas=JSON.parse(localStorage.getItem('entradas'))||[];
    let fiados=JSON.parse(localStorage.getItem('fiados'))||[];
    let e=entradas[i];

    if(e.pagamento==="fiado"){
        let f=fiados.find(x=>x.cliente===e.cliente);
        if(f){
            f.consumos=f.consumos.filter(x=>!(x.data===e.data && x.valor===e.valor));
            localStorage.setItem('fiados',JSON.stringify(fiados));
        }
    }

    entradas.splice(i,1);
    localStorage.setItem('entradas',JSON.stringify(entradas));
    listarEntradas();
    salvarNaNuvem();
}

listarEntradas();

// üî• Sincroniza√ß√£o na nuvem
function salvarNaNuvem(){
    const dados={
        clientes: JSON.parse(localStorage.getItem('clientes'))||[],
        entradas: JSON.parse(localStorage.getItem('entradas'))||[],
        fiados: JSON.parse(localStorage.getItem('fiados'))||[]
    };
    db.collection("backup").doc("entradas").set(dados);
}
</script>

</body>
</html>
